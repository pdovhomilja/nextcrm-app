// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// Multi-tenancy enums
enum OrganizationPlan {
  FREE
  PRO
  ENTERPRISE
}

enum OrganizationStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum OrganizationRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// Subscription Status Enum
enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
  UNPAID
}

// Payment Status Enum
enum PaymentStatus {
  SUCCEEDED
  PENDING
  FAILED
  CANCELED
  REFUNDED
}

// Invitation Status Enum
enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

// Organizations Model - Core multi-tenancy entity
model Organizations {
  id                String                @id @default(auto()) @map("_id") @db.ObjectId
  v                 Int                   @default(0) @map("__v")
  name              String
  slug              String                @unique
  plan              OrganizationPlan      @default(FREE)
  status            OrganizationStatus    @default(ACTIVE)
  createdAt         DateTime              @default(now()) @db.Date
  updatedAt         DateTime?             @updatedAt @db.Date
  ownerId           String                @db.ObjectId
  settings          Json?                 @default("{}")
  stripeCustomerId  String?               @unique
  deleteScheduledAt DateTime?             @db.Date

  // Relations
  owner             Users                     @relation(name: "owned_organizations", fields: [ownerId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  users             Users[]                   @relation(name: "user_organizations")
  invitations       OrganizationInvitations[]
  crm_accounts      crm_Accounts[]
  crm_leads         crm_Leads[]
  crm_contacts      crm_Contacts[]
  crm_opportunities crm_Opportunities[]
  crm_contracts     crm_Contracts[]
  invoices          Invoices[]
  documents         Documents[]
  tasks             Tasks[]
  boards            Boards[]
  sections          Sections[]
  subscriptions     Subscriptions[]
  paymentHistory    PaymentHistory[]
  crm_accounts_tasks crm_Accounts_Tasks[]
  usage             OrganizationUsage?
  auditLogs         AuditLog[]
  dataExports       DataExport[]
}

// Organization Invitations Model
model OrganizationInvitations {
  id             String           @id @default(auto()) @map("_id") @db.ObjectId
  v              Int              @default(0) @map("__v")
  organizationId String           @db.ObjectId
  email          String
  role           OrganizationRole @default(MEMBER)
  token          String           @unique
  status         InvitationStatus @default(PENDING)
  invitedBy      String           @db.ObjectId
  expiresAt      DateTime
  createdAt      DateTime         @default(now()) @db.Date
  updatedAt      DateTime?        @updatedAt @db.Date

  // Relations
  organization   Organizations    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedByUser  Users            @relation(name: "invited_by", fields: [invitedBy], references: [id], onDelete: NoAction)

  @@index([organizationId])
  @@index([email])
}

model crm_Accounts {
  id                   String               @id @default(auto()) @map("_id") @db.ObjectId
  v                    Int                  @map("__v")
  organizationId       String               @db.ObjectId
  createdAt            DateTime             @default(now()) @db.Date
  createdBy            String?              @db.ObjectId
  updatedAt            DateTime?            @updatedAt @db.Date
  updatedBy            String?              @db.ObjectId
  annual_revenue       String?
  assigned_to          String?              @db.ObjectId
  billing_city         String?
  billing_country      String?
  billing_postal_code  String?
  billing_state        String?
  billing_street       String?
  company_id           String?
  description          String?
  email                String?
  employees            String?
  fax                  String?
  industry             String?              @db.ObjectId
  member_of            String?
  name                 String
  office_phone         String?
  shipping_city        String?
  shipping_country     String?
  shipping_postal_code String?
  shipping_state       String?
  shipping_street      String?
  status               String?              @default("Inactive")
  type                 String?              @default("Customer")
  vat                  String?
  website              String?

  // Relations
  organization         Organizations        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoices             Invoices[]
  documentsIDs         String[]             @db.ObjectId
  assigned_documents   Documents[]          @relation(fields: [documentsIDs], references: [id])
  contacts             crm_Contacts[]
  leads                crm_Leads[]
  industry_type        crm_Industry_Type?   @relation(fields: [industry], references: [id])
  opportunities        crm_Opportunities[]
  assigned_to_user     Users?               @relation(fields: [assigned_to], references: [id])
  crm_accounts_tasks   crm_Accounts_Tasks[]
  contracts            crm_Contracts[]
  watchers             String[]             @db.ObjectId
  watching_users       Users[]              @relation(name: "watching_accounts", fields: [watchers], references: [id])
}

model crm_Leads {
  id String @id @default(auto()) @map("_id") @db.ObjectId
  v  Int    @default(0) @map("__v")

  organizationId     String        @db.ObjectId
  createdAt          DateTime?     @default(now()) @db.Date
  createdBy          String?       @db.ObjectId
  updatedAt          DateTime?     @updatedAt @db.Date
  updatedBy          String?       @db.ObjectId
  firstName          String?
  lastName           String
  company            String?
  jobTitle           String?
  email              String?
  phone              String?
  description        String?
  lead_source        String?
  refered_by         String?
  campaign           String?
  status             String?       @default("NEW")
  type               String?       @default("DEMO")
  assigned_to        String?       @db.ObjectId

  // Relations
  organization       Organizations @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assigned_to_user   Users?        @relation(fields: [assigned_to], references: [id])
  accountsIDs        String?       @db.ObjectId
  assigned_accounts  crm_Accounts? @relation(fields: [accountsIDs], references: [id])
  documentsIDs       String[]      @db.ObjectId
  assigned_documents Documents[]   @relation(fields: [documentsIDs], references: [id])
}

enum crm_Lead_Status {
  NEW
  CONTACTED
  QUALIFIED
  LOST
}

enum crm_Lead_Type {
  DEMO
}

model crm_Opportunities {
  id                   String                          @id @default(auto()) @map("_id") @db.ObjectId
  v                    Int                             @default(0) @map("__v")
  organizationId       String                          @db.ObjectId
  account              String?                         @db.ObjectId
  assigned_to          String?                         @db.ObjectId
  budget               Int                             @default(0)
  campaign             String?                         @db.ObjectId
  close_date           DateTime?                       @db.Date
  contact              String?                         @db.ObjectId
  created_by           String?                         @db.ObjectId
  createdBy            String?                         @db.ObjectId
  created_on           DateTime?                       @default(now()) @db.Date
  createdAt            DateTime                        @default(now()) @db.Date
  last_activity        DateTime?                       @db.Date
  updatedAt            DateTime?                       @updatedAt @db.Date
  updatedBy            String?                         @db.ObjectId
  last_activity_by     String?                         @db.ObjectId
  currency             String?
  description          String?
  expected_revenue     Int                             @default(0)
  name                 String?
  next_step            String?
  sales_stage          String?                         @db.ObjectId
  type                 String?                         @db.ObjectId
  status               crm_Opportunity_Status?         @default(ACTIVE)

  // Relations
  organization         Organizations                   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assigned_type        crm_Opportunities_Type?         @relation(fields: [type], references: [id])
  assigned_sales_stage crm_Opportunities_Sales_Stages? @relation(name: "assinged_sales_stage", fields: [sales_stage], references: [id])
  assigned_to_user     Users?                          @relation(name: "assigned_to_user_relation", fields: [assigned_to], references: [id])
  created_by_user      Users?                          @relation(name: "created_by_user_relation", fields: [created_by], references: [id])
  assigned_account     crm_Accounts?                   @relation(fields: [account], references: [id])
  assigned_campaings   crm_campaigns?                  @relation(fields: [campaign], references: [id])
  connected_documents  String[]                        @db.ObjectId
  documents            Documents[]                     @relation(fields: [connected_documents], references: [id])
  connected_contacts   String[]                        @db.ObjectId
  contacts             crm_Contacts[]                  @relation(fields: [connected_contacts], references: [id])
}

enum crm_Opportunity_Status {
  ACTIVE
  INACTIVE
  PENDING
  CLOSED
}

model crm_campaigns {
  id            String              @id @default(auto()) @map("_id") @db.ObjectId
  v             Int                 @map("__v")
  name          String
  description   String?
  status        String?
  opportunities crm_Opportunities[]
}

model crm_Opportunities_Sales_Stages {
  id                                 String              @id @default(auto()) @map("_id") @db.ObjectId
  v                                  Int                 @map("__v")
  name                               String
  probability                        Int?
  order                              Int?
  assigned_opportunities_sales_stage crm_Opportunities[] @relation(name: "assinged_sales_stage")
}

model crm_Opportunities_Type {
  id                     String              @id @default(auto()) @map("_id") @db.ObjectId
  v                      Int                 @map("__v")
  name                   String
  order                  Int?
  assigned_opportunities crm_Opportunities[]
}

model crm_Contacts {
  id                     String              @id @default(auto()) @map("_id") @db.ObjectId
  v                      Int                 @default(0) @map("__v")
  organizationId         String              @db.ObjectId
  account                String?             @db.ObjectId
  assigned_to            String?             @db.ObjectId
  birthday               String?
  created_by             String?             @db.ObjectId
  createdBy              String?             @db.ObjectId
  created_on             DateTime?           @default(now())
  cratedAt               DateTime?           @default(now()) @db.Date
  last_activity          DateTime?           @default(now()) @db.Date
  updatedAt              DateTime?           @updatedAt @db.Date
  updatedBy              String?             @db.ObjectId
  last_activity_by       String?             @db.ObjectId
  description            String?
  email                  String?
  personal_email         String?
  first_name             String?
  last_name              String
  office_phone           String?
  mobile_phone           String?
  website                String?
  position               String?
  status                 Boolean             @default(true)
  social_twitter         String?
  social_facebook        String?
  social_linkedin        String?
  social_skype           String?
  social_instagram       String?
  social_youtube         String?
  social_tiktok          String?
  type                   String?             @default("Customer")
  tags                   String[]
  notes                  String[]

  // Relations
  organization           Organizations       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assigned_to_user       Users?              @relation(name: "assigned_contacts", fields: [assigned_to], references: [id])
  crate_by_user          Users?              @relation(name: "created_contacts", fields: [created_by], references: [id])
  opportunitiesIDs       String[]            @db.ObjectId
  assigned_opportunities crm_Opportunities[] @relation(fields: [opportunitiesIDs], references: [id])
  accountsIDs            String?             @db.ObjectId
  assigned_accounts      crm_Accounts?       @relation(fields: [accountsIDs], references: [id])
  documentsIDs           String[]            @db.ObjectId
  assigned_documents     Documents[]         @relation(fields: [documentsIDs], references: [id])
}

enum crm_Contact_Type {
  Customer
  Partner
  Vendor
  Prospect
}

model crm_Contracts {
  id                  String               @id @default(auto()) @map("_id") @db.ObjectId
  v                   Int                  @map("__v")
  organizationId      String               @db.ObjectId
  title               String
  value               Int
  startDate           DateTime?            @default(now()) @db.Date
  endDate             DateTime?            @db.Date
  renewalReminderDate DateTime?            @db.Date
  customerSignedDate  DateTime?            @db.Date
  companySignedDate   DateTime?            @db.Date
  description         String?
  account             String?              @db.ObjectId
  assigned_to         String?              @db.ObjectId
  createdAt           DateTime?            @default(now()) @db.Date
  createdBy           String?              @db.ObjectId
  updatedAt           DateTime?            @updatedAt @db.Date
  updatedBy           String?              @db.ObjectId
  status              crm_Contracts_Status @default(NOTSTARTED)
  type                String?

  // Relations
  organization        Organizations        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assigned_account    crm_Accounts?        @relation(fields: [account], references: [id])
  assigned_to_user    Users?               @relation(fields: [assigned_to], references: [id])
}

enum crm_Contracts_Status {
  NOTSTARTED
  INPROGRESS
  SIGNED
}

model Boards {
  id                String    @id @default(auto()) @map("_id") @db.ObjectId
  v                 Int       @map("__v")
  organizationId    String    @db.ObjectId
  description       String
  favourite         Boolean?
  favouritePosition Int?
  icon              String?
  position          Int?
  title             String
  user              String    @db.ObjectId
  visibility        String?
  sharedWith        String[]  @db.ObjectId
  createdAt         DateTime? @default(now()) @db.Date
  createdBy         String?   @db.ObjectId
  updatedAt         DateTime? @updatedAt @db.Date
  updatedBy         String?   @db.ObjectId

  //Create watechers field for board. It will be array of users
  watchers       String[] @db.ObjectId

  // Relations
  organization   Organizations @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assigned_user  Users?        @relation(name: "assigned_user", fields: [user], references: [id])
  watchers_users Users[]        @relation(name: "watching_users", fields: [watchers], references: [id])
}

model Employees {
  id     String  @id @default(auto()) @map("_id") @db.ObjectId
  v      Int     @map("__v")
  avatar String
  email  String?
  name   String
  salary Int
  status String
}

model ImageUpload {
  id String @id @default(auto()) @map("_id") @db.ObjectId
}

model MyAccount {
  id                   String  @id @default(auto()) @map("_id") @db.ObjectId
  v                    Int     @map("__v")
  company_name         String
  is_person            Boolean @default(false)
  email                String?
  email_accountant     String?
  phone_prefix         String?
  phone                String?
  mobile_prefix        String?
  mobile               String?
  fax_prefix           String?
  fax                  String?
  website              String?
  // office Address
  street               String?
  city                 String?
  state                String?
  zip                  String?
  country              String?
  country_code         String?
  // billing Address
  billing_street       String?
  billing_city         String?
  billing_state        String?
  billing_zip          String?
  billing_country      String?
  billing_country_code String?
  //other
  currency             String?
  currency_symbol      String?
  VAT_number           String
  TAX_number           String?
  bank_name            String?
  bank_account         String?
  bank_code            String?
  bank_IBAN            String?
  bank_SWIFT           String?
}

model Invoices {
  id                            String          @id @default(auto()) @map("_id") @db.ObjectId
  v                             Int?            @map("__v")
  organizationId                String          @db.ObjectId
  date_created                  DateTime        @default(now()) @db.Date
  last_updated                  DateTime        @updatedAt
  last_updated_by               String?         @db.ObjectId
  date_received                 DateTime?       @default(now()) @db.Date
  date_of_case                  DateTime?       @db.Date
  date_tax                      DateTime?       @db.Date
  date_due                      DateTime?       @db.Date
  description                   String?
  document_type                 String?
  favorite                      Boolean?        @default(false)
  variable_symbol               String?
  constant_symbol               String?
  specific_symbol               String?
  order_number                  String?
  internal_number               String?
  invoice_number                String?
  invoice_amount                String?
  invoice_file_mimeType         String
  invoice_file_url              String
  invoice_items                 Json?
  invoice_type                  String?
  invoice_currency              String?
  invoice_language              String?
  partner                       String?
  partner_street                String?
  partner_city                  String?
  partner_zip                   String?
  partner_country               String?
  partner_country_code          String?
  partner_business_street       String?
  partner_business_city         String?
  partner_business_zip          String?
  partner_business_country      String?
  partner_business_country_code String?
  partner_VAT_number            String?
  partner_TAX_number            String?
  partner_TAX_local_number      String?
  partner_phone_prefix          String?
  partner_phone_number          String?
  partner_fax_prefix            String?
  partner_fax_number            String?
  partner_email                 String?
  partner_website               String?
  partner_is_person             Boolean?
  partner_bank                  String?
  partner_account_number        String?
  partner_account_bank_number   String?
  partner_IBAN                  String?
  partner_SWIFT                 String?
  partner_BIC                   String?
  rossum_status                 String?
  rossum_annotation_id          String?
  rossum_annotation_url         String?
  rossum_document_id            String?
  rossum_document_url           String?
  rossum_annotation_json_url    String?
  rossum_annotation_xml_url     String?
  money_s3_url                  String?
  status                        String?
  invoice_state_id              String?         @db.ObjectId
  assigned_user_id              String?         @db.ObjectId
  assigned_account_id           String?         @db.ObjectId
  visibility                    Boolean         @default(true)

  // Relations
  organization                  Organizations   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoice_states                invoice_States? @relation(fields: [invoice_state_id], references: [id])
  users                         Users?          @relation(fields: [assigned_user_id], references: [id])
  accounts                      crm_Accounts?   @relation(fields: [assigned_account_id], references: [id])
  connected_documents           String[]        @db.ObjectId
  documents                     Documents[]     @relation(fields: [connected_documents], references: [id])
}

model invoice_States {
  id                String     @id @default(auto()) @map("_id") @db.ObjectId
  name              String
  assigned_invoices Invoices[]
}

model Documents {
  id                     String              @id @default(auto()) @map("_id") @db.ObjectId
  v                      Int?                @map("__v")
  organizationId         String              @db.ObjectId
  date_created           DateTime?           @default(now()) @db.Date
  createdAt              DateTime?           @default(now()) @db.Date
  last_updated           DateTime?           @updatedAt
  updatedAt              DateTime?           @updatedAt @db.Date
  document_name          String
  created_by_user        String?             @db.ObjectId
  createdBy              String?             @db.ObjectId
  description            String?
  document_type          String?             @db.ObjectId
  favourite              Boolean?
  document_file_mimeType String
  document_file_url      String
  status                 String?
  visibility             String?
  tags                   Json?
  key                    String?
  size                   Int?
  assigned_user          String?             @db.ObjectId
  connected_documents    String[]
  invoiceIDs             String[]            @db.ObjectId
  opportunityIDs         String[]            @db.ObjectId
  contactsIDs            String[]            @db.ObjectId
  tasksIDs               String[]            @db.ObjectId
  crm_accounts_tasksIDs  String[]            @db.ObjectId
  leadsIDs               String[]            @db.ObjectId
  accountsIDs            String[]            @db.ObjectId

  // Relations
  organization           Organizations       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoices               Invoices[]          @relation(fields: [invoiceIDs], references: [id])
  opportunities          crm_Opportunities[] @relation(fields: [opportunityIDs], references: [id])
  contacts               crm_Contacts[]      @relation(fields: [contactsIDs], references: [id])
  tasks                  Tasks[]             @relation(fields: [tasksIDs], references: [id])
  crm_accounts_tasks     crm_Accounts_Tasks? @relation(fields: [crm_accounts_tasksIDs], references: [id])
  leads                  crm_Leads[]         @relation(fields: [leadsIDs], references: [id])
  accounts               crm_Accounts[]      @relation(fields: [accountsIDs], references: [id])
  created_by             Users?              @relation(name: "created_by_user", fields: [created_by_user], references: [id])
  assigned_to_user       Users?              @relation(name: "assigned_to_user", fields: [assigned_user], references: [id])
  documents_type         Documents_Types?    @relation(fields: [document_type], references: [id])
  document_system_type   DocumentSystemType? @default(OTHER)
}

enum DocumentSystemType {
  INVOICE
  RECEIPT
  CONTRACT
  OFFER
  OTHER
}

model Documents_Types {
  id                 String      @id @default(auto()) @map("_id") @db.ObjectId
  v                  Int         @map("__v")
  name               String
  assigned_documents Documents[]
}

model Sections {
  id             String         @id @default(auto()) @map("_id") @db.ObjectId
  v              Int            @map("__v")
  organizationId String         @db.ObjectId
  board          String         @db.ObjectId
  title          String
  position       Int?
  tasks          Tasks[]

  // Relations
  organization   Organizations  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([board])
}

model crm_Industry_Type {
  id       String         @id @default(auto()) @map("_id") @db.ObjectId
  v        Int            @map("__v")
  name     String
  accounts crm_Accounts[]
}

model modulStatus {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  name      String
  isVisible Boolean
}

model Tasks {
  id               String          @id @default(auto()) @map("_id") @db.ObjectId
  v                Int             @map("__v")
  organizationId   String          @db.ObjectId
  content          String?
  createdAt        DateTime?       @default(now()) @db.Date
  createdBy        String?         @db.ObjectId
  updatedAt        DateTime?       @updatedAt @db.Date
  updatedBy        String?         @db.ObjectId
  dueDateAt        DateTime?       @default(now()) @db.Date
  lastEditedAt     DateTime?       @default(now()) @updatedAt @db.Date
  position         Int
  priority         String
  section          String?         @db.ObjectId
  tags             Json?
  title            String
  likes            Int?            @default(0)
  user             String?         @db.ObjectId
  documentIDs      String[]        @db.ObjectId

  // Relations
  organization     Organizations   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  comments         tasksComments[]
  documents        Documents[]     @relation(fields: [documentIDs], references: [id])
  assigned_user    Users?          @relation(fields: [user], references: [id])
  assigned_section Sections?       @relation(fields: [section], references: [id])
  //Staus
  taskStatus       taskStatus?     @default(ACTIVE)
}

model crm_Accounts_Tasks {
  id            String          @id @default(auto()) @map("_id") @db.ObjectId
  v             Int             @map("__v")
  organizationId String          @db.ObjectId
  content       String?
  createdAt     DateTime?       @default(now()) @db.Date
  createdBy     String?         @db.ObjectId
  updatedAt     DateTime?       @updatedAt @db.Date
  updatedBy     String?         @db.ObjectId
  dueDateAt     DateTime?       @default(now()) @db.Date
  priority      String
  tags          Json?
  title         String
  likes         Int?            @default(0)
  user          String?         @db.ObjectId
  comments      tasksComments[]
  documents     Documents[]

  // Relations
  organization  Organizations   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  assigned_user Users?          @relation(fields: [user], references: [id])
  //CRM assigments
  account       String?         @db.ObjectId
  crm_accounts  crm_Accounts?   @relation(fields: [account], references: [id])
  //Staus
  taskStatus    taskStatus?     @default(ACTIVE)
}

model tasksComments {
  id                             String              @id @default(auto()) @map("_id") @db.ObjectId
  v                              Int                 @map("__v")
  comment                        String
  createdAt                      DateTime            @default(now()) @db.Date
  task                           String              @db.ObjectId
  user                           String              @db.ObjectId
  assigned_crm_account_task      String?             @db.ObjectId
  assigned_crm_account_task_task crm_Accounts_Tasks? @relation(fields: [assigned_crm_account_task], references: [id])
  assigned_task                  Tasks?              @relation(fields: [task], references: [id], onDelete: Cascade)
  assigned_user                  Users?              @relation(fields: [user], references: [id])
}

enum taskStatus {
  ACTIVE
  PENDING
  COMPLETE
}

model TodoList {
  id          String @id @default(auto()) @map("_id") @db.ObjectId
  createdAt   String
  description String
  title       String
  url         String
  user        String
}

enum ActiveStatus {
  ACTIVE
  INACTIVE
  PENDING
}

model Users {
  id                   String                @id @default(auto()) @map("_id") @db.ObjectId
  v                    Int                   @default(0) @map("__v")
  account_name         String?
  avatar               String?
  email                String                @unique
  is_account_admin     Boolean               @default(false)
  is_admin             Boolean               @default(false)
  created_on           DateTime              @default(now()) @db.Date
  lastLoginAt          DateTime?             @db.Date
  name                 String?
  password             String?
  username             String?
  userStatus           ActiveStatus          @default(PENDING)
  userLanguage         Language              @default(en)

  // Multi-tenancy fields
  organizationId       String?               @db.ObjectId
  organization_role    OrganizationRole      @default(MEMBER)

  // Relations
  organization         Organizations?            @relation(name: "user_organizations", fields: [organizationId], references: [id], onUpdate: NoAction, onDelete: NoAction)
  owned_organizations  Organizations[]           @relation(name: "owned_organizations")
  sent_invitations     OrganizationInvitations[] @relation(name: "invited_by")
  tasksComment         tasksComments[]
  created_by_documents Documents[]               @relation(name: "created_by_user")
  assigned_documents   Documents[]               @relation(name: "assigned_to_user")
  tasks                Tasks[]
  crm_accounts_tasks   crm_Accounts_Tasks[]
  accounts             crm_Accounts[]
  leads                crm_Leads[]
  created_by_user      crm_Opportunities[]       @relation(name: "created_by_user_relation")
  assigned_opportunity crm_Opportunities[]       @relation(name: "assigned_to_user_relation")
  assigned_contacts    crm_Contacts[]            @relation(name: "assigned_contacts")
  crated_contacts      crm_Contacts[]            @relation(name: "created_contacts")
  notion_account       secondBrain_notions[]
  openAi_key           openAi_keys[]
  assigned_invoices    Invoices[]
  assigned_contracts   crm_Contracts[]
  boards               Boards[]                  @relation(name: "assigned_user")
  watching_boardsIDs   String[]                  @db.ObjectId
  watching_boards      Boards[]                  @relation(name: "watching_users", fields: [watching_boardsIDs], references: [id])
  watching_accountsIDs String[]                  @db.ObjectId
  watching_accounts    crm_Accounts[]            @relation(name: "watching_accounts", fields: [watching_accountsIDs], references: [id])
  auditLogs            AuditLog[]
  sessions             UserSession[]
  dataExports          DataExport[]
}

enum Language {
  cz
  en
  de
  uk
}

model system_Modules_Enabled {
  id       String  @id @default(auto()) @map("_id") @db.ObjectId
  v        Int     @map("__v")
  name     String
  enabled  Boolean
  position Int
}

model secondBrain_notions {
  id             String @id @default(auto()) @map("_id") @db.ObjectId
  v              Int    @map("__v")
  user           String @db.ObjectId
  notion_api_key String
  notion_db_id   String
  assigned_user  Users? @relation(fields: [user], references: [id])
}

model openAi_keys {
  id              String @id @default(auto()) @map("_id") @db.ObjectId
  v               Int    @map("__v")
  user            String @db.ObjectId
  organization_id String
  api_key         String
  assigned_user   Users? @relation(fields: [user], references: [id])
}

model systemServices {
  id              String  @id @default(auto()) @map("_id") @db.ObjectId
  v               Int     @map("__v")
  name            String
  serviceUrl      String?
  serviceId       String?
  serviceKey      String?
  servicePassword String?
  servicePort     String?
  description     String?
}

model gpt_models {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  v           Int        @map("__v")
  model       String
  description String?
  status      gptStatus?
  created_on  DateTime?  @default(now()) @db.Date
}

enum gptStatus {
  ACTIVE
  INACTIVE
}

model Subscriptions {
  id                     String              @id @default(auto()) @map("_id") @db.ObjectId
  v                      Int                 @default(0) @map("__v")
  organizationId         String              @db.ObjectId
  stripeCustomerId       String
  stripeSubscriptionId   String              @unique
  stripePriceId          String
  status                 SubscriptionStatus  @default(ACTIVE)
  currentPeriodStart     DateTime            @db.Date
  currentPeriodEnd       DateTime            @db.Date
  cancelAtPeriodEnd      Boolean             @default(false)
  canceledAt             DateTime?           @db.Date
  trialStart             DateTime?           @db.Date
  trialEnd               DateTime?           @db.Date
  createdAt              DateTime            @default(now()) @db.Date
  updatedAt              DateTime?           @updatedAt @db.Date

  // Relations
  organization           Organizations       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model PaymentHistory {
  id                     String              @id @default(auto()) @map("_id") @db.ObjectId
  v                      Int                 @default(0) @map("__v")
  organizationId         String              @db.ObjectId
  stripePaymentIntentId  String              @unique
  stripeInvoiceId        String?
  amount                 Int
  currency               String              @default("usd")
  status                 PaymentStatus       @default(PENDING)
  description            String?
  receiptUrl             String?
  createdAt              DateTime            @default(now()) @db.Date

  // Relations
  organization           Organizations       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

// Organization Usage Tracking Model
model OrganizationUsage {
  id                     String              @id @default(auto()) @map("_id") @db.ObjectId
  organizationId         String              @unique @db.ObjectId
  usersCount             Int                 @default(0)
  contactsCount          Int                 @default(0)
  storageBytes           Int                 @default(0)
  projectsCount          Int                 @default(0)
  documentsCount         Int                 @default(0)
  accountsCount          Int                 @default(0)
  leadsCount             Int                 @default(0)
  opportunitiesCount     Int                 @default(0)
  tasksCount             Int                 @default(0)
  lastCalculatedAt       DateTime?           @updatedAt @db.Date
  createdAt              DateTime            @default(now()) @db.Date
  updatedAt              DateTime?           @updatedAt @db.Date

  // Relations
  organization           Organizations       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

// Audit Actions Enum
enum AuditAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  EXPORT
  LOGIN
  LOGOUT
  INVITE
  REMOVE
  ROLE_CHANGE
  SETTINGS_CHANGE
  SUBSCRIPTION_CHANGE
  PAYMENT
  PERMISSION_DENIED
  RATE_LIMIT_EXCEEDED
}

// Audit Log Model for Security and Compliance
model AuditLog {
  id                     String              @id @default(auto()) @map("_id") @db.ObjectId
  v                      Int                 @default(0) @map("__v")
  organizationId         String              @db.ObjectId
  userId                 String?             @db.ObjectId
  action                 AuditAction
  resource               String
  resourceId             String?
  changes                Json?
  ipAddress              String?
  userAgent              String?
  createdAt              DateTime            @default(now()) @db.Date

  // Relations
  organization           Organizations       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user                   Users?              @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([userId])
  @@index([createdAt])
  @@index([action])
  @@index([resource])
}

// Session Model for Enhanced Security
model UserSession {
  id                     String              @id @default(auto()) @map("_id") @db.ObjectId
  v                      Int                 @default(0) @map("__v")
  userId                 String              @db.ObjectId
  token                  String              @unique
  ipAddress              String?
  userAgent              String?
  device                 String?
  location               String?
  isActive               Boolean             @default(true)
  lastActivityAt         DateTime            @default(now()) @db.Date
  createdAt              DateTime            @default(now()) @db.Date
  expiresAt              DateTime            @db.Date

  // Relations
  user                   Users               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isActive])
}

// Organization Deletion Status Enum
enum OrganizationDeletionStatus {
  ACTIVE
  SCHEDULED_FOR_DELETION
  DELETED
}

// Data Export Model
model DataExport {
  id                     String              @id @default(auto()) @map("_id") @db.ObjectId
  v                      Int                 @default(0) @map("__v")
  organizationId         String              @db.ObjectId
  userId                 String              @db.ObjectId
  status                 ExportStatus        @default(PENDING)
  fileUrl                String?
  expiresAt              DateTime?           @db.Date
  createdAt              DateTime            @default(now()) @db.Date
  completedAt            DateTime?           @db.Date

  // Relations
  organization           Organizations       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user                   Users               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([status])
}

// Export Status Enum
enum ExportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  EXPIRED
}

// ============================================================================
// PRODUCTION BACKEND SYSTEMS - Admin, Tenants, and Integrations
// ============================================================================

// Admin User Role Enum
enum AdminRole {
  SUPER_ADMIN
  ADMIN
  DEVELOPER
  SUPPORT
  MARKETING
  FINANCE
  SALES
}

// Admin User Model
model AdminUser {
  id                String        @id @default(auto()) @map("_id") @db.ObjectId
  firstName         String
  lastName          String
  email             String        @unique
  password          String
  role              AdminRole     @default(ADMIN)
  department        String?
  isActive          Boolean       @default(true)
  mfaEnabled        Boolean       @default(false)
  mfaSecret         String?
  lastLoginAt       DateTime?
  lastActivityAt    DateTime?
  createdAt         DateTime      @default(now()) @db.Date
  updatedAt         DateTime?     @updatedAt @db.Date
  avatar            String?
  phone             String?

  // Relations
  auditLogs         AdminAuditLog[]
  sessions          AdminSession[]
  notifications     NotificationLog[]

  @@index([email])
  @@index([role])
  @@index([isActive])
}

// Admin Session Model
model AdminSession {
  id                String        @id @default(auto()) @map("_id") @db.ObjectId
  adminUserId       String        @db.ObjectId
  token             String        @unique
  ipAddress         String?
  userAgent         String?
  isActive          Boolean       @default(true)
  lastActivityAt    DateTime      @default(now()) @db.Date
  createdAt         DateTime      @default(now()) @db.Date
  expiresAt         DateTime

  // Relations
  adminUser         AdminUser     @relation(fields: [adminUserId], references: [id], onDelete: Cascade)

  @@index([adminUserId])
  @@index([isActive])
}

// Tenant Model (Workshop/Business)
enum TenantStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
  TRIAL_EXPIRED
}

enum TenantPlan {
  PROFESSIONAL
  PERFORMANCE
  ENTERPRISE
}

model Tenant {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId
  name              String
  subdomain         String            @unique
  slug              String            @unique
  plan              TenantPlan        @default(PROFESSIONAL)
  status            TenantStatus      @default(ACTIVE)
  primaryContactId   String?           @db.ObjectId
  stripeCustomerId  String?           @unique
  website           String?
  logo              String?
  description       String?
  businessDetails   Json?
  metadata          Json?
  createdAt         DateTime          @default(now()) @db.Date
  updatedAt         DateTime?         @updatedAt @db.Date
  deletedAt         DateTime?

  // Relations
  primaryContact    TenantUser?       @relation("primaryContact", fields: [primaryContactId], references: [id])
  users             TenantUser[]
  subscription      Subscription?
  usage             UsageMetric[]
  supportTickets    SupportTicket[]
  integrations      TenantIntegration[]
  auditLogs         AdminAuditLog[]

  @@index([status])
  @@index([plan])
  @@index([createdAt])
}

// Tenant User Model
enum TenantUserRole {
  OWNER
  ADMIN
  USER
  VIEWER
}

model TenantUser {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId
  tenantId          String            @db.ObjectId
  firstName         String
  lastName          String
  email             String
  password          String
  role              TenantUserRole    @default(USER)
  isActive          Boolean           @default(true)
  lastLoginAt       DateTime?
  lastActivityAt    DateTime?
  createdAt         DateTime          @default(now()) @db.Date
  updatedAt         DateTime?         @updatedAt @db.Date
  avatar            String?
  phone             String?

  // Relations
  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  asPrimaryContact  Tenant[]          @relation("primaryContact")
  sessions          TenantSession[]
  auditLogs         AdminAuditLog[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
}

// Tenant Session Model
model TenantSession {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId
  tenantUserId      String            @db.ObjectId
  token             String            @unique
  ipAddress         String?
  userAgent         String?
  isActive          Boolean           @default(true)
  lastActivityAt    DateTime          @default(now()) @db.Date
  createdAt         DateTime          @default(now()) @db.Date
  expiresAt         DateTime

  // Relations
  tenantUser        TenantUser        @relation(fields: [tenantUserId], references: [id], onDelete: Cascade)

  @@index([tenantUserId])
  @@index([isActive])
}

// Usage Metric Model for Analytics
model UsageMetric {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId
  tenantId          String            @db.ObjectId
  date              DateTime          @default(now()) @db.Date
  metricType        String            // 'API_CALLS', 'USERS', 'STORAGE', etc.
  value             Int               @default(0)
  details           Json?
  createdAt         DateTime          @default(now()) @db.Date

  // Relations
  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([date])
  @@index([metricType])
}

// Notification Log Model
enum NotificationStatus {
  SENT
  FAILED
  BOUNCED
  PENDING
}

model NotificationLog {
  id                String              @id @default(auto()) @map("_id") @db.ObjectId
  adminUserId       String?             @db.ObjectId
  recipientEmail    String
  type              String              // 'EMAIL', 'SMS', 'IN_APP'
  channel           String              // 'SMTP', 'SENDGRID', 'SMS_PROVIDER'
  subject           String?
  content           String
  status            NotificationStatus  @default(PENDING)
  sentAt            DateTime?
  errorMessage      String?
  metadata          Json?
  createdAt         DateTime            @default(now()) @db.Date

  // Relations
  adminUser         AdminUser?          @relation(fields: [adminUserId], references: [id])

  @@index([recipientEmail])
  @@index([status])
  @@index([createdAt])
}

// Admin Audit Log (separate from user audit logs)
model AdminAuditLog {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId
  adminUserId       String            @db.ObjectId
  tenantId          String?           @db.ObjectId
  tenantUserId      String?           @db.ObjectId
  action            String
  resource          String
  resourceId        String?
  changes           Json?
  ipAddress         String?
  userAgent         String?
  statusCode        Int?
  errorMessage      String?
  createdAt         DateTime          @default(now()) @db.Date

  // Relations
  adminUser         AdminUser         @relation(fields: [adminUserId], references: [id], onDelete: Cascade)
  tenant            Tenant?           @relation(fields: [tenantId], references: [id])
  tenantUser        TenantUser?       @relation(fields: [tenantUserId], references: [id])

  @@index([adminUserId])
  @@index([tenantId])
  @@index([action])
  @@index([createdAt])
}

// Tenant Integration Model
enum IntegrationType {
  CAPRICORN_EDI
  STRIPE_PAYMENT
  SLACK_NOTIFICATION
  CUSTOM_WEBHOOK
}

model TenantIntegration {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId
  tenantId          String            @db.ObjectId
  type              IntegrationType
  name              String
  isActive          Boolean           @default(true)
  credentials       Json              // Encrypted in production
  webhookUrl        String?
  webhookSecret     String?
  lastSyncedAt      DateTime?
  metadata          Json?
  createdAt         DateTime          @default(now()) @db.Date
  updatedAt         DateTime?         @updatedAt @db.Date

  // Relations
  tenant            Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, type])
  @@index([tenantId])
  @@index([type])
}

// Capricorn EDI Integration Models
model CapricornOrder {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId
  externalOrderId   String            @unique
  tenantId          String            @db.ObjectId
  items             Json
  status            String            @default("PENDING")
  totalAmount       Int?
  currency          String            @default("AUD")
  capricornResponse Json?
  errorMessage      String?
  createdAt         DateTime          @default(now()) @db.Date
  updatedAt         DateTime?         @updatedAt @db.Date

  @@index([externalOrderId])
  @@index([status])
  @@index([createdAt])
}

model CapricornInventory {
  id                String            @id @default(auto()) @map("_id") @db.ObjectId
  synId             String            @unique
  data              Json
  lastSyncedAt      DateTime?
  createdAt         DateTime          @default(now()) @db.Date
  updatedAt         DateTime?         @updatedAt @db.Date
}

// Support Ticket Model
enum SupportTicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_FOR_CUSTOMER
  RESOLVED
  CLOSED
}

enum SupportTicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model SupportTicket {
  id                String                  @id @default(auto()) @map("_id") @db.ObjectId
  ticketNumber      String                  @unique
  tenantId          String                  @db.ObjectId
  subject           String
  description       String
  status            SupportTicketStatus     @default(OPEN)
  priority          SupportTicketPriority   @default(MEDIUM)
  assignedToId      String?                 @db.ObjectId
  createdByEmail    String
  resolvedAt        DateTime?
  closedAt          DateTime?
  createdAt         DateTime                @default(now()) @db.Date
  updatedAt         DateTime?               @updatedAt @db.Date
  metadata          Json?

  // Relations
  tenant            Tenant                  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assignedTo        AdminUser?              @relation(fields: [assignedToId], references: [id])

  @@index([tenantId])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
}
